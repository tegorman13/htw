---
title: Experiment 1 Analysis
date: last-modified
categories: [Analysis, R]
page-layout: full
# fig-width: 15
# fig-height: 8
code-fold: true
code-tools: true
toc: false
execute: 
  warning: false
  eval: true
---


```{r setup}
pacman::p_load(tidyverse,lme4,emmeans,here,knitr,kableExtra,gt,gghalves,patchwork,ggforce,ggdist)
e1 <- readRDS(here("data/e1_07-27-23.rds"))
source(here("Functions/Display_Functions.R"))

train <- e1 |> filter(expMode %in% c("train"))
trainAvg <- train %>% group_by(id, condit, vb, bandInt,trainStage) %>%
  summarise(nHits=sum(dist==0),vx=mean(vx),dist=mean(dist),sdist=mean(sdist),n=n(),Percent_Hit=nHits/n)
test <- e1 |> filter(expMode %in% c("test-Nf","test-train-nf"))
testAvg <- test %>% group_by(id, condit, vb, bandInt,bandType,tOrder) %>%
  summarise(nHits=sum(dist==0),vx=mean(vx),dist=mean(dist),sdist=mean(sdist),n=n(),Percent_Hit=nHits/n)

```



## Dictionary

| Variable Name | Variable Levels                 | Description                                                                               |
|---------------|---------------------------------|-------------------------------------------------------------------------------------------|
| condit        | Constant, Varied                | Condition of the experiment: constant or varied                                             |
| tOrder        | Test First, Train First         | Order of testing and training stages: test first or train first                            |
| expMode       | train, train-Nf, test-Nf, etc.  | Mode of the experiment: train, train-Nf, test-Nf, etc.                                    |
| trainStage    | Beginning, Middle, End, Test    | Stage of the training: beginning, middle, end, or test                                    |
| expStage      | TrainStart, intTest1, etc.      | Stage of the experiment: TrainStart, intTest1, TrainMid1, etc.                            |
| band          | 1, 2, 3, 4, 5, 6               | Band number                                                                                 |
| vb            | 100-300, 350-550, etc.         | Velocity band range                                                                         |
| lowBound      | 100, 350, 600, etc.            | Lower bound of the velocity band range                                                      |
| feedback      | 0, 1                           | Feedback type: 0 (no feedback), 1 (feedback)                                               |
| stage         | 1, 2, 3, etc.                  | Stage number of the experiment                                                              |

---






<!-- ::: panel-tabset -->
<!-- ## Figure -->
<!-- ```{r} -->
<!-- #| column: page-inset-right -->
<!-- #| fig-cap: "Mean Vx over training blocks" -->

<!-- # vpt1=plotWithTable(vp1,vt1,arrange="V") -->
<!-- nb=5 -->
<!-- vp1=e1 |> filter(expMode=="train") |> learn_curve_plot(gt.train,vx,condit,facet_var=vb,groupVec=c(gt.train,condit,tOrder,id,vb),nbins=nb) -->
<!-- vp1 -->

<!-- ``` -->


<!-- ## Table -->
<!-- ```{r} -->
<!-- #| tbl-cap: "Mean Vx over blocks. Mean (Standard Error)" -->
<!-- #| tbl-cap-location: top -->

<!-- vt1=e1 |> filter(expMode=="train") |> -->
<!--   learn_curve_table(gt.train,vx,gw=Trial_Bin,groupVec=c(vb,condit),nbins=nb,prefix="Block_") |> -->
<!--   rename("Band"=vb,"Group"=condit) -->
<!-- vt1 %>% kable() -->


<!-- ``` -->
<!-- ::: -->




<!-- ::: {layout="[ [1,4],[1,5],[1,10]]"} -->

```{r}
#| tbl-cap: "Mean Vx over blocks. Mean (Standard Error)"
#| tbl-cap-location: top
nb=5
vt1=e1 |> filter(expMode=="train") |>
  learn_curve_table(gt.train,vx,gw=Trial_Bin,groupVec=c(id,vb,condit),nbins=nb,prefix="Block_") |>
  rename("Band"=vb,"Group"=condit)
vt1 %>% kable() 

vt1 %>% kable() %>% add_header_above(c(" "," "= 1, "Training Block"=5))

vt1 %>% gt() %>% tab_options(column_labels.background.color = "#176940",
                table.font.size = px(14))




```

```{r}
#| fig-cap: "Mean Vx over training blocks"
#| fig-width: 10
#| fig-height: 9
#| tbl-cap: "test table"

# vpt1=plotWithTable(vp1,vt1,arrange="V")
nb=5
vp1=e1 |> filter(expMode=="train") |> learn_curve_plot(gt.train,vx,condit,facet_var=vb,groupVec=c(gt.train,condit,tOrder,id,vb),nbins=nb)
vp1

#vp1 / gridExtra::tableGrob(vt1)
#vp1 / gt_temp(vt1)


```

```{r}
#| tbl-cap: "Deviation over blocks. Mean (Standard Error)"
#| tbl-cap-location: bottom
#| results: asis

# vt2=e1 |> filter(expMode=="train") |> 
#   learn_curve_table(gt.train,dist,gw=condit,groupVec=c(id,condit,vb),nbins=nb) %>%
#   rename("Block"=Trial_Bin)

vt2=e1 |> filter(expMode=="train") |> 
  learn_curve_table(gt.train,dist,gw=Trial_Bin,groupVec=c(id,condit,vb),nbins=nb,prefix="Block_") %>%
  rename("Band"=vb,"Group"=condit) 

```

```{r}
#| fig-cap: "Absolute Deviation from Band over training"
#| fig-width: 8

vp2=e1 |> filter(expMode=="train") |> 
  learn_curve_plot(gt.train,dist,condit,facet_var=vb,groupVec=c(gt.train,condit,tOrder,id,vb),nbins=nb) 
vp2



```



```{r}
#| tbl-cap: "Signed Deviation over blocks. Mean (Standard Error)"
#| tbl-cap-location: bottom

vt3=e1 |> filter(expMode=="train") |> 
  learn_curve_table(gt.train,sdist,gw=Trial_Bin,groupVec=c(id,vb,condit),nbins=nb,prefix="Block_") |>
  rename("Band"=vb,"Group"=condit) 
vt3 %>% kable(format = "html",escape = FALSE)
```





```{r}
#| fig-cap: "Signed Deviation from Band over training"
#| fig-width: 8

vp3=e1 |> filter(expMode=="train") |> learn_curve_plot(gt.train,sdist,condit,facet_var=vb,groupVec=c(gt.train,condit,tOrder,id,vb),nbins=nb) 
vp3

```


<!-- ::: -->

```{r}
vp4 <- e1 |> filter(expMode=="train") |> group_by(id) |>
  mutate(Trial_Bin = cut(gt.train,breaks = nb,include.lowest=TRUE,labels=FALSE)) |>
  group_by(id,Trial_Bin,condit, vb) |> summarise(nHits=sum(dist==0),n=n(),Percent_Hit=nHits/n) %>%
  learn_curve_plot2(Trial_Bin,Percent_Hit,color_var=condit,facet_var=vb,groupVec=c(id,vb,condit))



```


# 22
::: {.column-page-right}
```{r}
#| layout: [[65, 65],[-5], [1,550, 550]]
#| label: train tables2
#| echo: fenced
#| tbl-subcap: 
#|   - "Vx"
#|   - "Deviation from target"

vt1 %>% kable(format = "html",escape = FALSE)
vt2 %>% kable(format = "html",escape = FALSE)

vp3+big_text()
vp4+big_text()

```
::: 



# 33
```{r}
#| layout: [[65, 65],[-5], [1,350, 350,10]]
#| label: train tables
#| echo: fenced
#| tbl-subcap: 
#|   - "Vx"
#|   - "Deviation from target"
#| column: screen-inset-right

vt1 %>% kable(format = "html",escape = FALSE)
vt2 %>% kable(format = "html",escape = FALSE)

vp3
vp4
```


```{r}
#| label: tbl-example4
#| tbl-cap: "Example"
#| tbl-subcap: 
#|   - "Signed Distance"
#|   - "Percent Hit"
#| layout: [[80, 90],[2], [-60,650]]
#| echo: fenced
#| column: screen-inset-right
#| fig-width: 14
#| 


vt2 %>% kable(format = "html",escape = FALSE) %>% kable_styling(font_size = 7)
vt3 %>% kable(format = "html",escape = FALSE)

vp4+vp3 + plot_layout(guides = "collect") & theme(legend.position = 'right')


```

```{r}
#| fig-width: 12
#| fig-height: 11
#| column: page-inset-right
((vp1+big_text()+vp2+big_text())/(vp3+big_text()+vp4+big_text())) + plot_layout(guides = "collect") 



```



<!-- ```{r} -->
<!-- #| layout-ncol: 2 -->
<!-- #| fig-cap:  -->
<!-- #|   - "Speed and Stopping Distances of Cars" -->
<!-- #|   - "Vapor Pressure of Mercury as a Function of Temperature" -->

<!-- vp1 -->
<!-- vp2 -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| tbl-cap: "Training" -->
<!-- #| tbl-subcap:  -->
<!-- #|   - "Speed and Stopping Distances of Cars" -->
<!-- #|   - "Vapor Pressure of Mercury as a Function of Temperature" -->
<!-- #| layout-ncol: 2 -->
<!-- #| echo: fenced -->

<!-- vt1 %>% kable() -->
<!-- vt2 %>% kable() -->
<!-- ``` -->





## Testing


::: panel-tabset

### Varied vs. Constant
```{r}
#| fig-width: 8
e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  
  ggplot(aes(x = vb, y = dist,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 
```
### Dist
```{r}
e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  ggplot(aes(x = vb, y = dist,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 

```

### Vx
```{r}

e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  ggplot(aes(x = vb, y = vx,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 

testAvg |>  ggplot(aes(x = vb, y = vx,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 

```

### Signed Distance
```{r}

e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  ggplot(aes(x = vb, y = sdist,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 


testAvg |>  ggplot(aes(x = vb, y = sdist,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 

```
### Percent Hit
```{r}

testAvg |>  ggplot(aes(x = vb, y = Percent_Hit,fill=condit)) +
    stat_summary(geom = "bar", position=position_dodge(), fun = mean) +
    stat_summary(geom = "errorbar", position=position_dodge(.9), fun.data = mean_se, width = .4, alpha = .7) 

```


::: 


```{r}
#| fig-height: 11
#| fig-width: 12
#| 
rectWidth=.4
vbRect<- e1 %>% group_by(vb) %>% 
  summarise(lowBound=first(bandInt),highBound=first(highBound)) %>% mutate(vbn=as.numeric(vb),
                  vbLag=vbn-rectWidth,vbLead=vbn+rectWidth)

e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  ggplot(aes(x = condit, y = vx,fill=vb)) + 
  ggdist::stat_halfeye()


vbRect<- e1 |> group_by(vb) |>
  summarise(lowBound=first(bandInt),highBound=first(highBound)) |> 
  mutate(vbn=as.numeric(vb), rectWidth=.2,
                  vbLag=vbn-rectWidth,vbLead=vbn+rectWidth)

e1 |> filter(expMode %in% c("test-Nf","test-train-nf")) |>  
  ggplot(aes(x = vb, y = vx,fill=vb)) + 
  ggdist::stat_halfeye(alpha=.5) + 
  geom_rect(data=vbRect,aes(xmin=vbLag,xmax=vbLead,ymin=lowBound,ymax=highBound,fill=vb),alpha=.3,inherit.aes = FALSE)+
  scale_y_continuous(expand=expansion(add=100),breaks=round(seq(0,2400,by=200),2)) +
  geom_segment(data=vbRect, aes(x=vbLag,xend=vbLead,y=highBound,yend=highBound),alpha=1,linetype="dashed")+
  geom_segment(data=vbRect, aes(x=vbLag,xend=vbLead,y=lowBound,yend=lowBound),alpha=1,linetype="dashed")+
  geom_text(data=vbRect,aes(x=vbLag-.03,y=lowBound+100,label=vb),angle=90,size=3.5,fontface="bold")


testAvg |>  
  ggplot(aes(x = vb, y = vx,fill=vb)) + 
  ggdist::stat_halfeye(alpha=.5,width=.7) + 
  geom_rect(data=vbRect,aes(xmin=vbLag,xmax=vbLead,ymin=lowBound,ymax=highBound,fill=vb),alpha=.3,inherit.aes = FALSE)+
  facet_wrap(~condit,ncol=1)+
  scale_y_continuous(expand=expansion(add=100),breaks=round(seq(0,2000,by=200),2)) +
  geom_segment(data=vbRect, aes(x=vbLag,xend=vbLead,y=highBound,yend=highBound),alpha=1,linetype="dashed",inherit.aes = FALSE)+
  geom_segment(data=vbRect, aes(x=vbLag,xend=vbLead,y=lowBound,yend=lowBound),alpha=1,linetype="dashed",inherit.aes = FALSE)+
  geom_text(data=vbRect,aes(x=vbLag-.03,y=lowBound+100,label=vb),angle=90,size=5.5,fontface="bold",inherit.aes = FALSE)  
  


# testAvg |>  
#   ggplot(aes(x = vb, y = sdist,fill=vb)) + 
#   ggdist::stat_halfeye(alpha=.5,width=.7) + 
#   facet_wrap(~condit,ncol=1)
# 
# 
# testAvg |>  
#   ggplot(aes(x = vb, y = dist,fill=vb)) + 
#   ggdist::stat_halfeye(alpha=.5,width=.7) + 
#   facet_wrap(~condit,ncol=1)
# 
# 


```



```{r}
#| fig-height: 11
#| fig-width: 12
#| 
sumStats2 = test %>% group_by(id,condit,vb) %>%
  summarise(distMean=mean(dist),distMedian=median(dist),distSd=sd(dist)) %>%group_by(condit,vb) %>%
  summarise(groupMean=round(mean(distMean),0),groupMedian=round(mean(distMedian),0),groupSd=round(mean(distSd),0)) %>%
  mutate(meanLab=paste0("Mean=",groupMean),medianLab=paste0("Median=",groupMedian),sdLab=paste0("Sd=",groupSd)) %>%
  mutate(sumStatLab=paste0(meanLab,"\n",medianLab,"\n",sdLab))

sumStats = test %>% group_by(id,condit,vb) %>%
  summarise(distMean=mean(vx),distMedian=median(vx),distSd=sd(vx)) %>%group_by(condit,vb) %>%
  summarise(groupMean=round(mean(distMean),0),groupMedian=round(mean(distMedian),0),groupSd=round(mean(distSd),0)) %>%
  mutate(meanLab=paste0("Mean=",groupMean),medianLab=paste0("Median=",groupMedian),sdLab=paste0("Sd=",groupSd)) %>%
  mutate(sumStatLab=paste0(meanLab,"\n",medianLab,"\n",sdLab))

bandLines4 <- list(geom_segment(data=vbRect,aes(x=vbLag,xend=vbLead,y=highBound,yend=highBound),alpha=1,linetype="dashed"),
                   geom_segment(data=vbRect,aes(x=vbLag,xend=vbLead,y=lowBound,yend=lowBound),alpha=1,linetype="dashed"),
                   geom_text(data=vbRect,aes(x=vbLag-.03,y=lowBound+100,label=vb),angle=90,size=2.5,fontface="bold") )    


test %>% group_by(id,vb,condit) %>% 
  summarise(vxMean=mean(vx)) %>%
  ggplot(aes(x=vb,y=vxMean,fill=vb))+
  gghalves::geom_half_violin(color=NA)+ # remove border color
  gghalves::geom_half_boxplot(position=position_nudge(x=-0.05),side="r",outlier.shape = NA,center=TRUE, 
                    errorbar.draw = FALSE,width=.25)+
  gghalves::geom_half_point(transformation = position_jitter(width = 0.05, height = 0.05),size=.3,aes(color=vb))+
  facet_wrap(~condit,scale="free_x")+
  geom_rect(data=vbRect,aes(xmin=vbLag,xmax=vbLead,ymin=lowBound,ymax=highBound,fill=vb),alpha=.3,inherit.aes = FALSE)+
  bandLines4+
  #geom_text(data=sumStats,aes(x=vb,y=2100,label = groupMean),size=2, vjust = -0.5)+
  scale_y_continuous(expand=expansion(add=100),breaks=round(seq(0,2000,by=200),2))+
  theme(legend.position='none',
        plot.title=element_text(face="bold"),
        axis.title.x=element_text(face="bold"),
        axis.title.y=element_text(face="bold"),
        axis.text.x = element_text(size = 7.5))+
  ylab("Mean X Velocity")+xlab("Target Velocity Band") + 
  ggtitle("Testing Performance (no-feedback) - X-Velocity Per Band")+ 
  geom_text(data=sumStats2,aes(y=2090,label = sumStatLab),size=1.9)



test %>% group_by(id,vb,condit) %>% 
  summarise(distMean=mean(dist)) %>% 
  ggplot(aes(x=vb,y=distMean,fill=vb))+
  geom_half_violin(color=NA)+ # remove border color
  geom_half_boxplot(position=position_nudge(x=-0.05),side="r",outlier.shape = NA,center=TRUE, 
                    errorbar.draw = FALSE,width=.25)+
  geom_half_point(transformation = position_jitter(width = 0.05, height = 0.05),size=.3,aes(color=vb))+
  facet_wrap(~condit,scale="free_x")+
  scale_y_continuous(expand=expansion(add=100),breaks=round(seq(0,2000,by=200),2))+
  theme(legend.position='none',
        plot.title=element_text(face="bold"),
        axis.title.x=element_text(face="bold"),
        axis.title.y=element_text(face="bold"),
        axis.text.x = element_text(size = 9.0))+
  ylab("Mean Distance From Boundary")+xlab("Target Velocity Band") + 
  ggtitle("Testing Performance (no-feedback) - Absolute Distance from Boundary")+ 
  geom_text(data=sumStats2,aes(y=1200,label = sumStatLab),size=3,fontface="bold")



```

```{r}
#| fig-height: 11
#| fig-width: 12
test %>% group_by(sbjCode,condit,vb) %>% 
  summarise(distMean=mean(dist)) %>% 
  ggplot(aes(x=condit,y=distMean,fill=condit))+
  stat_summary(geom="bar",fun=mean,position=position_nudge(x=.21),alpha=.7,width=.2)+
   stat_summary(geom="errorbar",fun.data=mean_se,position=position_nudge(x=.21),alpha=.7,width=.1,)+
  geom_half_violin(position=position_dodge(.5),alpha=.55,color=NA)+ # remove border color
  geom_half_boxplot(position=position_dodge(.5),side="r",outlier.shape = NA,center=TRUE, 
                    errorbar.draw = FALSE,width=.25,alpha=.55)+
  geom_half_point(transformation = position_jitter(width = 0.05, height = 0.05),alpha=.2,size=.3)+
  facet_wrap(~vb,scale="free_x")+
  scale_y_continuous(expand=expansion(add=200),breaks=round(seq(0,2000,by=200),2))+
  theme(legend.position='none',
        plot.title=element_text(face="bold"),
        axis.title.x=element_text(face="bold"),
        axis.title.y=element_text(face="bold"),
        axis.text.x = element_text(size = 9.0))+
  ylab("Mean Distance From Boundary")+xlab("Training Condition") + 
  ggtitle("Testing Performance (no-feedback) - Absolute Distance from Boundary")+ 
  geom_text(data=sumStats2,aes(y=1390,label = sumStatLab),position=position_dodge(.5),size=3,fontface="bold")







```


```{r}





```



```{r}




```





```{r}
#| fig-height: 13
#| fig-width: 12
library(ggforce)

testAvg %>% ggplot(aes(x=vx,y=condit,col=condit))+ ggdist::stat_halfeye()+facet_col(facets="vb")
testAvg %>% ggplot(aes(x=sdist,y=condit,col=condit))+ geom_boxplot()+facet_col(facets="vb")+geom_vline(xintercept=0)+theme_classic()

library(ggh4x)
library(ggdist)

testAvg %>% ggplot(aes(x=vx,y=vb,col=bandType)) +  ggdist::stat_halfeye(normalize="groups")+ facet_nested_wrap(vars(condit,tOrder),nrow=2)+theme_classic()

testAvg %>% ggplot(aes(x=vx,y=vb,col=bandType)) +  ggdist::stat_histinterval(normalize="groups")+ facet_nested_wrap(vars(condit,tOrder),nrow=2)+theme_classic()

testAvg %>% ggplot(aes(x=vx,y=vb,col=bandType)) +  ggdist::stat_histinterval(normalize="groups")+ facet_nested_wrap(vars(condit,tOrder),nrow=2)+theme_classic()


e1 |> group_by(id, condit, vb, bandInt,bandType,tOrder,expMode2) %>%
  summarise(vx=mean(vx),dist=mean(dist),sdist=mean(sdist)) %>%
  ggplot(aes(x=vx,y=condit,col=condit)) +  ggdist::stat_histinterval(normalize="groups")+ facet_nested_wrap(vars(vb,expMode2),nrow=6)+theme_classic()

e1 |> group_by(id, condit, vb, bandInt,bandType,tOrder,expMode2) %>%
  summarise(vx=mean(vx),dist=mean(dist),sdist=mean(sdist)) %>% ggplot(aes(x=sdist,y=vb,col=condit))+ stat_histinterval(normalize="groups",position=position_dodge())+facet_col(facets="expMode2")+geom_vline(xintercept=0)+theme_classic()

```


