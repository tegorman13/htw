---
title: Organization
---

```{r}

pacman::p_load(tidyverse,here,knitr,kableExtra,reactable)
options(dplyr.summarise.inform=FALSE)
d <- readRDS(here("data/dPrune-07-27-23.rds")) %>% ungroup()


d <- d |> mutate(bandType=case_when(
  vb %in% c("1000-1200","1200-1400") & condit=="Constant" & bandOrder=="Original" ~ "Extrapolation",
  vb %in% c("100-300","350-550") & condit=="Constant" & bandOrder=="Reverse" ~ "Extrapolation",
  (vb %in% c("100-300","350-550","600-800") & bandOrder=="Original") |
  (vb %in% c("1200-1400","1000-1200","800-1000") & bandOrder=="Reverse") ~ "Extrapolation",
  
  (vb %in% c("800-1000","1000-1200","1200-1400") & bandOrder=="Original") |
  (vb %in% c("100-300","350-550","600-800") & bandOrder=="Reverse") ~ "Trained",
  TRUE ~ NA_character_
))

d$bandType <- factor(d$bandType,levels=c("Trained","Extrapolation"))
d<- d %>% relocate(bandOrder,bandType,.after=bandInt)

# test <- d |> filter(expMode %in% c("test-Nf","test-train-nf"))
# rtest <- test |> filter(bandOrder=="Reverse")
# rtest |> group_by(vb,bandType,condit,tOrder) |> summarise(n=n()) 

```

```{r}
#| eval: false
e1 <- d |> filter(fb=="Continuous" & bandOrder=="Original")
e2 <- d |> filter(fb=="Continuous" & bandOrder=="Reverse")
e3 <- d |> filter(fb=="Ordinal")

date.append="07-27-23"

# saveRDS(d,here(paste0("data/dAll_",date.append,".rds")))
# saveRDS(e1,here(paste0("data/e1_",date.append,".rds")))
# saveRDS(e2,here(paste0("data/e2_",date.append,".rds")))
# saveRDS(e3,here(paste0("data/e3_",date.append,".rds")))

# save csv versions
#d %>% write_csv(here(paste0("data/dAll_",date.append,".csv")))
# e1 %>% write_csv(here(paste0("data/e1_",date.append,".csv")))
# e2 %>% write_csv(here(paste0("data/e2_",date.append,".csv")))
# e3 %>% write_csv(here(paste0("data/e3_",date.append,".csv")))

```


head(d)
colnames(d)
d %>% select_if(is.factor) %>% colnames()


```{r}

d %>% select_if(is.factor) %>% select(-sbjCode,-id) %>% map(levels)
d %>% select_if(is.factor) %>% select(-sbjCode,-id) %>% droplevels %>% map(levels)

```


```{r}
d %>% select_if(is.numeric) |> colnames()
```



```{r}
d %>%
  distinct(id, condit, fb, bandOrder, tOrder) %>%
  group_by(condit, fb, bandOrder, tOrder) %>%
  summarise(n = n()) %>%
  kable()
```




```{r}

# Average trials per subject by condition  
d %>%
  group_by(condit, fb, bandOrder, tOrder, id) %>%
  summarise(n = n()) %>%
  group_by(condit, fb, bandOrder, tOrder) %>%
  summarise(mean_trials = mean(n)) %>%
  kable()


d %>%
  group_by(condit, fb, bandOrder, tOrder, id, expMode) %>% 
  summarise(n = n()) %>%
  pivot_wider(names_from = expMode, values_from = n, names_prefix = "n_") %>%
  group_by(condit, fb, bandOrder, tOrder) %>%
  summarise(across(starts_with("n_"), ~mean(., na.rm = TRUE))) %>%
  kable()

```


```{r}
#| column: page-right
#| 
# Define column defs function 
col_defs <- function(data) {
  
  cols <- colnames(data)
  
  defs <- lapply(cols, function(x) {
    
    if(is.factor(data[[x]])) {
      colDef(sortable = TRUE, filterable = TRUE,minWidth=108) 
    } else {
      colDef(sortable = TRUE, filterable = FALSE,minWidth=90)
    }
    
  })
  
  setNames(defs, cols)
}

d %>%
  group_by(id,condit, fb, bandOrder, tOrder, expMode) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = expMode, values_from = n, names_prefix = "n_") %>%
  
  # Pass original data too 
  reactable(columns = col_defs(.), 
            highlight = TRUE,
            defaultPageSize = 25)
```




```{r}
d %>% filter(nGoodTrial==1,nTotal>100) %>% ggplot(aes(nTotal)) + geom_histogram() + facet_wrap(~condit)
d %>% filter(nGoodTrial==1,nTotal>100) %>% ggplot(aes(nTestNf)) + geom_histogram() + facet_wrap(~condit)
d %>% filter(nGoodTrial==1,nTotal>100) %>% ggplot(aes(nTrain)) + geom_histogram() + facet_wrap(~condit)

```
